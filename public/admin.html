<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunoMate - Artist Manager</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .search-bar {
            margin-bottom: 20px;
        }

        .artists-list {
            padding: 30px;
            max-height: 600px;
            overflow-y: auto;
        }

        .search-bar {
            position: sticky;
            top: 0;
            background: white;
            padding: 15px 0;
            z-index: 10;
            margin-bottom: 20px;
        }

        .artist-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 6px 10px;
            margin-bottom: 4px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .artist-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .artist-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .artist-card.highlighted {
            animation: highlight 2s ease;
        }

        @keyframes highlight {
            0%, 100% { background: white; }
            50% { background: #fff3cd; }
        }

        .artist-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .artist-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .artist-name {
            font-size: 0.95em;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 2px;
        }

        .artist-style {
            color: #718096;
            line-height: 1.3;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .artist-details {
            margin-top: 8px;
        }

        .artist-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .artist-actions .btn {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 32px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: #f8f9fa;
        }

        .stat-card {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .api-settings {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-settings h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
            background: white;
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }

        .form-check input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-check label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        .form-note {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="container">
        <div class="header">
            <h1>🎵 Suno Artist Manager</h1>
            <p>Login Required</p>
        </div>

        <div class="controls">
            <div id="loginAlertContainer"></div>

            <div class="form-group">
                <label for="loginPassword">Enter Password:</label>
                <input type="password" id="loginPassword" placeholder="Enter password" autofocus>
            </div>

            <div>
                <button class="btn btn-primary" onclick="login()" id="loginBtn">🔓 Login</button>
            </div>
        </div>
    </div>

    <!-- Main App (hidden by default) -->
    <div id="mainApp" class="container" style="display: none;">
        <div class="header">
            <h1>🎵 Suno Artist Manager</h1>
            <p>ניהול מאגר אמנים וסטיילים למוזיקה</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalArtists">0</div>
                <div class="stat-label">סה״כ אמנים</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="enabledStatus">-</div>
                <div class="stat-label">סטטוס</div>
            </div>
        </div>

        <div class="controls">
            <div id="alertContainer"></div>

            <div class="toggle-container">
                <label>
                    <strong>הפעל/כבה את המערכת:</strong>
                </label>
                <label class="switch">
                    <input type="checkbox" id="enableToggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="api-settings">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">🤖 הגדרות AI Generator</h3>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <div style="font-size: 0.85em; color: #856404;" id="adminApiIndicator">
                            -
                        </div>
                        <a href="#" id="toggleAdminApiSettings" style="color: #856404; font-size: 0.9em; text-decoration: underline;">
                            הגדרות ▼
                        </a>
                    </div>
                </div>

                <div id="adminApiSettingsSection" style="display: none;">
                    <div class="form-group">
                        <label for="llmProvider">מודל AI:</label>
                        <select id="llmProvider">
                            <option value="gemini-2.5-flash">Google - Gemini 2.5 Flash</option>
                            <option value="gemini-2.0-flash" selected>Google - Gemini 2.0 Flash (מומלץ)</option>
                            <option value="gemini-1.5-pro">Google - Gemini 1.5 Pro</option>
                            <option value="gemini-2.5-pro-preview-05-06">Google - Gemini 2.5 Pro Preview</option>
                            <option value="claude-sonnet-4-5-20250929">Anthropic - Claude 4.5 Sonnet (החדש ביותר)</option>
                            <option value="claude-sonnet-4-20250514">Anthropic - Claude 4 Sonnet</option>
                            <option value="claude-3-7-sonnet-20250219">Anthropic - Claude 3.7 Sonnet</option>
                            <option value="claude-3-5-sonnet-latest">Anthropic - Claude 3.5 Sonnet</option>
                            <option value="claude-3-5-haiku-latest">Anthropic - Claude 3.5 Haiku</option>
                            <option value="claude-3-haiku-20240307">Anthropic - Claude 3 Haiku</option>
                            <option value="gpt-5-chat-latest">OpenAI - GPT-5 Chat Latest</option>
                            <option value="gpt-4.1-2025-04-14">OpenAI - GPT-4.1</option>
                            <option value="gpt-4.1-mini">OpenAI - GPT-4.1-mini</option>
                            <option value="gpt-4o">OpenAI - GPT-4o</option>
                            <option value="o4-mini">OpenAI - o4-Mini</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="apiKey">API Key:</label>
                        <input type="password" id="apiKey" placeholder="הדבק את ה-API key שלך כאן">
                        <p class="form-note" id="apiKeyNote">הזן את ה-API key שלך למודל שבחרת.</p>
                        <div class="form-check">
                            <input type="checkbox" id="saveApiKey" checked>
                            <label for="saveApiKey">שמור API key בדפדפן (רק במכשיר הזה)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="artistName">שם האמן:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="artistName" placeholder="לדוגמה: Billy Joel" style="flex: 1;">
                    <button class="btn btn-ai" onclick="generateStyle()" id="generateBtn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; white-space: nowrap;">
                        🤖 AI Generator
                    </button>
                </div>
                <div class="form-check" style="margin-top: 8px;">
                    <input type="checkbox" id="regenerateExisting" checked>
                    <label for="regenerateExisting" style="font-weight: 400; font-size: 0.9em; color: #6c757d;">
                        🔄 Regenerate existing artists? (אם לא מסומן, ידלג על אמנים קיימים)
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label for="artistStyle">תיאור הסטייל (מפורט):</label>
                <textarea id="artistStyle" placeholder="לדוגמה: Pop, Rock, Storytelling, piano-driven, male vocals, upbeat"></textarea>
            </div>

            <div>
                <button class="btn btn-primary" onclick="saveArtist()">💾 שמור/עדכן אמן</button>
                <button class="btn btn-success" onclick="loadArtists()">🔄 רענן רשימה</button>
                <button class="btn" onclick="downloadJSON()" style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white;">📥 הורד JSON</button>
            </div>
        </div>

        <div class="artists-list">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="🔍 חפש אמן..." onkeyup="filterArtists()">
                <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-primary" onclick="sortArtists('name')" style="font-size: 13px; padding: 6px 12px;">
                        🔤 Name
                    </button>
                    <button class="btn btn-success" onclick="sortArtists('recent')" style="font-size: 13px; padding: 6px 12px;">
                        🕐 Recent
                    </button>
                    <select id="genreFilter" onchange="filterByGenre()" style="font-size: 13px; padding: 6px 12px; width: auto;">
                        <option value="">All Genres</option>
                    </select>
                    <div style="font-size: 13px; color: #667eea; font-weight: 600; white-space: nowrap;" id="displayIndicator">
                        Showing: 0 | Selected: 0
                    </div>
                    <div style="flex: 1"></div>
                    <button class="btn" onclick="selectAllVisible()" style="font-size: 13px; padding: 6px 12px; background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); color: white;">
                        ☑️ Select All
                    </button>
                    <button class="btn" onclick="deselectAll()" style="font-size: 13px; padding: 6px 12px; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white;">
                        ◻️ Deselect All
                    </button>
                    <button class="btn" onclick="regenerateSelected()" id="regenerateSelectedBtn" style="font-size: 13px; padding: 6px 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;" disabled>
                        🔄 Regenerate Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-danger" onclick="regenerateAll()" style="font-size: 13px; padding: 6px 12px;">
                        🔥 Regenerate All
                    </button>
                </div>
            </div>
            <div id="artistsList"></div>
        </div>
    </div>

    <script>
        let artistsData = { enabled: true, artists: {} };
        const API_URL = window.location.origin;
        let serverEnvKeys = {};
        let sessionPassword = ''; // Store password for session
        let selectedArtists = new Set(); // Track selected artists
        let lastClickedIndex = null; // For shift-click selection

        // Login function
        async function login() {
            const loginPassword = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.textContent;

            if (!loginPassword) {
                showLoginAlert('Please enter password', 'error');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = '⏳ Checking...';

            try {
                // Test password by trying to fetch artists
                const response = await fetch(`${API_URL}/api/artists`);

                if (!response.ok) {
                    throw new Error('Cannot connect to server');
                }

                // Store password in session and localStorage
                sessionPassword = loginPassword;
                localStorage.setItem('adminPassword', loginPassword);

                // Hide login screen
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';

                // Initialize the app
                initializeApp();

                // Load data
                loadArtists();
                initializeApiSettings();

                loginBtn.textContent = '✅ Logged in!';

            } catch (error) {
                showLoginAlert('Login failed: ' + error.message, 'error');
                loginBtn.disabled = false;
                loginBtn.textContent = originalText;
            }
        }

        // Check if already logged in
        function checkLogin() {
            const savedPassword = localStorage.getItem('adminPassword');

            if (savedPassword) {
                sessionPassword = savedPassword;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                initializeApp();
                loadArtists();
                initializeApiSettings();
            }
        }

        // Handle Enter key on login
        document.addEventListener('DOMContentLoaded', () => {
            const loginPasswordInput = document.getElementById('loginPassword');
            if (loginPasswordInput) {
                loginPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
        });

        function showLoginAlert(message, type) {
            const alertContainer = document.getElementById('loginAlertContainer');
            const alertClass = type === 'error' ? 'alert-error' : 'alert-success';

            alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Helper function to get provider name from model ID
        function getProviderName(modelId) {
            if (!modelId) return 'unknown';
            if (modelId.startsWith('gemini')) { return 'google'; }
            else if (modelId.startsWith('claude')) { return 'anthropic'; }
            else if (modelId.startsWith('gpt') || modelId.startsWith('o')) { return 'openai'; }
            return 'unknown';
        }

        // API Key management (localStorage)
        function saveApiKeyToLocalStorage(modelId, apiKey) {
            const providerName = getProviderName(modelId);
            if (providerName !== 'unknown') {
                localStorage.setItem(`apiKey_${providerName}`, apiKey);
                console.log(`Saved API key for provider: ${providerName}`);
            } else {
                console.warn(`Could not determine provider for model: ${modelId}. Key not saved.`);
            }
        }

        function loadApiKeyFromLocalStorage(modelId) {
            const providerName = getProviderName(modelId);
            if (providerName !== 'unknown') {
                return localStorage.getItem(`apiKey_${providerName}`);
            }
            return null;
        }

        function isApiKeyAvailable(modelId) {
            const localKey = loadApiKeyFromLocalStorage(modelId);
            return !!localKey;
        }

        function updateApiInputState(loadSavedKey = false) {
            const modelId = document.getElementById('llmProvider').value;
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyNote = document.getElementById('apiKeyNote');
            const providerName = getProviderName(modelId);

            // Update note based on provider
            let noteText = `הזן API key עבור ${providerName}.`;
            let links = {
                'google': 'https://aistudio.google.com/apikey',
                'anthropic': 'https://console.anthropic.com/',
                'openai': 'https://platform.openai.com/api-keys'
            };

            if (links[providerName]) {
                noteText += ` <a href="${links[providerName]}" target="_blank" style="color: #667eea;">קבל מפתח כאן</a>`;
            }

            apiKeyNote.innerHTML = noteText;

            // Only load saved key if explicitly requested (on provider change or page load)
            if (loadSavedKey) {
                const localKey = loadApiKeyFromLocalStorage(modelId);
                if (localKey) {
                    apiKeyInput.value = localKey;
                    document.getElementById('saveApiKey').checked = true;
                } else {
                    apiKeyInput.value = '';
                    document.getElementById('saveApiKey').checked = false;
                }
            }
        }

        async function initializeApiSettings() {
            // Load saved API key for current model
            updateApiInputState(true); // Pass true to load saved key
        }

        // Update admin API indicator
        function updateAdminApiIndicator() {
            const modelId = document.getElementById('llmProvider').value;
            const savedKey = loadApiKeyFromLocalStorage(modelId);
            const currentKey = document.getElementById('apiKey').value.trim();
            const hasKey = !!(savedKey || currentKey);

            const modelName = document.getElementById('llmProvider').options[document.getElementById('llmProvider').selectedIndex].text;
            const indicator = document.getElementById('adminApiIndicator');

            if (hasKey) {
                indicator.innerHTML = `✅ ${modelName}`;
                indicator.style.color = '#28a745';
            } else {
                indicator.innerHTML = `⚠️ No API key`;
                indicator.style.color = '#dc3545';
            }
        }

        // Initialize app after login
        function initializeApp() {
            // Setup toggle listener
            setupToggleListener();

            // Toggle admin API settings
            const toggleAdminApiSettings = document.getElementById('toggleAdminApiSettings');
            const adminApiSettingsSection = document.getElementById('adminApiSettingsSection');

            toggleAdminApiSettings.addEventListener('click', function(e) {
                e.preventDefault();
                const isVisible = adminApiSettingsSection.style.display !== 'none';
                adminApiSettingsSection.style.display = isVisible ? 'none' : 'block';
                this.textContent = isVisible ? 'הגדרות ▼' : 'הגדרות ▲';
            });

            // Event listeners for API settings
            const llmProviderDropdown = document.getElementById('llmProvider');
            const apiKeyInput = document.getElementById('apiKey');
            const saveApiKeyCheckbox = document.getElementById('saveApiKey');

            llmProviderDropdown.addEventListener('change', function() {
                // Load saved key when provider changes
                updateApiInputState(true);
                updateAdminApiIndicator();
            });

            apiKeyInput.addEventListener('input', function() {
                updateAdminApiIndicator();
            });

            apiKeyInput.addEventListener('blur', function() {
                // Auto-save if checkbox is checked
                if (saveApiKeyCheckbox.checked && this.value.trim()) {
                    const modelId = llmProviderDropdown.value;
                    saveApiKeyToLocalStorage(modelId, this.value.trim());
                    showAlert('API key נשמר בדפדפן ✓', 'success');
                    updateAdminApiIndicator();
                }
            });

            saveApiKeyCheckbox.addEventListener('change', function() {
                const modelId = llmProviderDropdown.value;
                const key = apiKeyInput.value.trim();

                if (this.checked && key) {
                    saveApiKeyToLocalStorage(modelId, key);
                    showAlert('API key נשמר בדפדפן', 'success');
                } else if (!this.checked) {
                    // Clear saved key
                    const providerName = getProviderName(modelId);
                    localStorage.removeItem(`apiKey_${providerName}`);
                    showAlert('API key הוסר מהדפדפן', 'success');
                }
                updateAdminApiIndicator();
            });

            // Update indicator on load
            updateAdminApiIndicator();
        }

        // Load artists on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Check if already logged in
            checkLogin();
        });

        async function loadArtists() {
            try {
                const response = await fetch(`${API_URL}/api/artists`);
                artistsData = await response.json();

                updateStats();
                displayArtists();
                updateToggle();
            } catch (error) {
                showAlert('שגיאה בטעינת האמנים', 'error');
            }
        }

        function updateStats() {
            document.getElementById('totalArtists').textContent = Object.keys(artistsData.artists).length;
            document.getElementById('enabledStatus').textContent = artistsData.enabled ? '✅ פעיל' : '❌ כבוי';
        }

        function updateToggle() {
            document.getElementById('enableToggle').checked = artistsData.enabled;
        }

        let currentSort = 'name'; // Default sort
        let currentGenreFilter = ''; // Current genre filter
        let currentSearchTerm = ''; // Track current search term

        function displayArtists(highlightArtist = null) {
            const artistsList = document.getElementById('artistsList');

            // Get artists with timestamps if available
            let artists = Object.entries(artistsData.artists || {});

            if (artists.length === 0) {
                artistsList.innerHTML = '<p style="text-align: center; color: #6c757d;">אין אמנים במאגר</p>';
                return;
            }

            // Add timestamps from metadata if available
            const artistsWithMeta = artists.map(([name, styleOrObj]) => {
                // Support both string styles and object with {style, timestamp}
                if (typeof styleOrObj === 'object' && styleOrObj.style) {
                    return [name, styleOrObj.style, styleOrObj.timestamp || 0];
                } else {
                    return [name, styleOrObj, artistsData.metadata?.[name]?.timestamp || 0];
                }
            });

            // Sort based on current sort mode
            if (currentSort === 'name') {
                artistsWithMeta.sort((a, b) => a[0].localeCompare(b[0]));
            } else if (currentSort === 'recent') {
                artistsWithMeta.sort((a, b) => b[2] - a[2]); // Newest first
            }

            // Build genre list
            updateGenreFilter(artistsWithMeta);

            artistsList.innerHTML = artistsWithMeta.map(([name, style, timestamp], index) => {
                const isSelected = selectedArtists.has(name);
                const isHighlighted = highlightArtist === name;
                return `
                <div class="artist-card ${isSelected ? 'selected' : ''} ${isHighlighted ? 'highlighted' : ''}" data-name="${name}" data-index="${index}" data-genre="${getGenreFromStyle(style)}">
                    <input type="checkbox" class="artist-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleArtistSelection('${escapeHtml(name)}', event)" onclick="handleCheckboxClick(event, ${index})">
                    <div class="artist-info" onclick="toggleArtistDetails('${escapeHtml(name)}')">
                        <div class="artist-name">${name}</div>
                        <div class="artist-style" title="${escapeHtml(style)}">${style}</div>
                        <div class="artist-details" id="details-${escapeHtml(name)}" style="display: none;">
                            <textarea class="edit-textarea" id="edit-${escapeHtml(name)}" style="width: 100%; margin-top: 10px; padding: 8px; border-radius: 4px; border: 1px solid #dee2e6; font-size: 0.9em;">${escapeHtml(style)}</textarea>
                            <button class="btn btn-primary" onclick="saveInlineEdit('${escapeHtml(name)}'); event.stopPropagation();" style="margin-top: 8px; padding: 4px 12px; font-size: 0.85em;">💾 שמור</button>
                        </div>
                    </div>
                    <div class="artist-actions">
                        <button class="btn btn-primary" onclick="editArtist('${escapeHtml(name)}', '${escapeHtml(style)}')">✏️</button>
                        <button class="btn btn-success" onclick="regenerateArtist('${escapeHtml(name)}')">🔄</button>
                        <button class="btn btn-danger" onclick="deleteArtist('${escapeHtml(name)}')">🗑️</button>
                    </div>
                </div>
            `}).join('');

            // Apply genre filter if active
            if (currentGenreFilter) {
                filterByGenre();
            }

            // Apply search filter if active
            if (currentSearchTerm) {
                applySearchFilter();
            }

            // Scroll to highlighted artist
            if (highlightArtist) {
                setTimeout(() => {
                    const card = document.querySelector(`.artist-card[data-name="${highlightArtist}"]`);
                    if (card) {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }

            updateSelectedCount();

            // Update display indicator if no filters are active (show all count)
            if (!currentSearchTerm && !currentGenreFilter) {
                setTimeout(() => updateDisplayIndicator(), 50);
            }
        }

        function getGenreFromStyle(style) {
            if (!style) return 'Unknown';

            // Common main genres to detect (case-insensitive)
            const mainGenres = [
                'Pop', 'Rock', 'Hip-Hop', 'Rap', 'Jazz', 'Blues', 'Country', 'Electronic',
                'Dance', 'Classical', 'R&B', 'RnB', 'Soul', 'Funk', 'Reggae', 'Metal',
                'Punk', 'Folk', 'Indie', 'Alternative', 'Gospel', 'Latin', 'Ska',
                'Disco', 'House', 'Techno', 'Trance', 'Dubstep', 'Reggaeton',
                'Psytrance', 'Qawwali', 'Rockabilly', 'Roll', 'Salsa', 'Score',
                'Senegalese', 'Shoegaze', 'Son', 'Revival'
            ];

            // Convert to lowercase for comparison
            const styleLower = style.toLowerCase();

            // Check each main genre
            for (const genre of mainGenres) {
                const genreLower = genre.toLowerCase();

                // Check if style contains this genre (as whole word or part of compound)
                // Match patterns like: "pop", "synth-pop", "dark pop", "pop rock"
                const regex = new RegExp(`(^|[\\s,-]|dark |synth-|indie-|alt-|electro-|dream-|art-|power-)${genreLower}([\\s,.-]|$)`, 'i');

                if (regex.test(styleLower)) {
                    return genre; // Return with proper capitalization
                }
            }

            // If no main genre found, get first word from style
            const firstPart = style.split(',')[0].trim();
            const words = firstPart.split(/[\s-]/); // Split by space or hyphen

            // Capitalize first letter
            const fallback = words[words.length - 1];
            return fallback.charAt(0).toUpperCase() + fallback.slice(1).toLowerCase();
        }

        function updateGenreFilter(artistsWithMeta) {
            const genreFilter = document.getElementById('genreFilter');
            const genres = new Set();

            artistsWithMeta.forEach(([name, style]) => {
                const genre = getGenreFromStyle(style);
                genres.add(genre);
            });

            const sortedGenres = Array.from(genres).sort();
            const currentValue = genreFilter.value;

            genreFilter.innerHTML = '<option value="">All Genres</option>' +
                sortedGenres.map(genre => `<option value="${genre}">${genre}</option>`).join('');

            genreFilter.value = currentValue;
        }

        function filterByGenre() {
            const genreFilter = document.getElementById('genreFilter');
            currentGenreFilter = genreFilter.value;

            const cards = document.querySelectorAll('.artist-card');
            cards.forEach(card => {
                if (!currentGenreFilter || card.dataset.genre === currentGenreFilter) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });

            updateDisplayIndicator();
        }

        function toggleArtistSelection(name, event) {
            if (event.target.checked) {
                selectedArtists.add(name);
            } else {
                selectedArtists.delete(name);
            }

            const card = document.querySelector(`.artist-card[data-name="${name}"]`);
            if (card) {
                card.classList.toggle('selected', event.target.checked);
            }

            updateSelectedCount();
        }

        function handleCheckboxClick(event, index) {
            if (event.shiftKey && lastClickedIndex !== null) {
                // Shift-click: select range
                const start = Math.min(lastClickedIndex, index);
                const end = Math.max(lastClickedIndex, index);
                const cards = document.querySelectorAll('.artist-card');

                for (let i = start; i <= end; i++) {
                    const card = cards[i];
                    if (card) {
                        const name = card.dataset.name;
                        const checkbox = card.querySelector('.artist-checkbox');
                        checkbox.checked = true;
                        selectedArtists.add(name);
                        card.classList.add('selected');
                    }
                }

                updateSelectedCount();
                event.preventDefault();
            }

            lastClickedIndex = index;
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedArtists.size;
            document.getElementById('regenerateSelectedBtn').disabled = selectedArtists.size === 0;
            updateDisplayIndicator();
        }

        function updateDisplayIndicator() {
            const allCards = document.querySelectorAll('.artist-card');
            let visibleCount = 0;

            allCards.forEach(card => {
                if (card.style.display !== 'none') {
                    visibleCount++;
                }
            });

            const indicator = document.getElementById('displayIndicator');
            indicator.textContent = `Showing: ${visibleCount} | Selected: ${selectedArtists.size}`;
        }

        function selectAllVisible() {
            const allCards = document.querySelectorAll('.artist-card');

            allCards.forEach(card => {
                if (card.style.display !== 'none') {
                    const name = card.dataset.name;
                    const checkbox = card.querySelector('.artist-checkbox');

                    selectedArtists.add(name);
                    checkbox.checked = true;
                    card.classList.add('selected');
                }
            });

            updateSelectedCount();
            showAlert(`בחרת ${selectedArtists.size} אמנים`, 'success');
        }

        function deselectAll() {
            const allCards = document.querySelectorAll('.artist-card');

            allCards.forEach(card => {
                const checkbox = card.querySelector('.artist-checkbox');
                checkbox.checked = false;
                card.classList.remove('selected');
            });

            selectedArtists.clear();
            updateSelectedCount();
            showAlert('הבחירה בוטלה', 'success');
        }

        function sortArtists(sortType) {
            currentSort = sortType;
            displayArtists();
        }

        function filterArtists() {
            currentSearchTerm = document.getElementById('searchInput').value.toLowerCase();
            applySearchFilter();
        }

        function applySearchFilter() {
            const cards = document.querySelectorAll('.artist-card');

            cards.forEach(card => {
                const name = card.dataset.name.toLowerCase();
                if (name.includes(currentSearchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });

            updateDisplayIndicator();
        }

        async function saveArtist() {
            const name = document.getElementById('artistName').value.trim();
            const style = document.getElementById('artistStyle').value.trim();

            if (!name || !style) {
                showAlert('נא למלא את שם האמן והסטייל', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/artists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, style, password: sessionPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('האמן נשמר בהצלחה!', 'success');

                    // Store the artist name to keep in focus
                    const savedArtistName = name;

                    document.getElementById('artistName').value = '';
                    document.getElementById('artistStyle').value = '';

                    // Reload and highlight the saved artist, keeping search filter
                    await loadArtists();

                    // Set search to the saved artist name to keep it in focus
                    document.getElementById('searchInput').value = savedArtistName;
                    currentSearchTerm = savedArtistName.toLowerCase();

                    displayArtists(savedArtistName);
                } else {
                    showAlert(data.error || 'שגיאה בשמירה', 'error');
                }
            } catch (error) {
                showAlert('שגיאת רשת', 'error');
            }
        }

        // Toggle artist details for inline editing
        function toggleArtistDetails(name) {
            const detailsDiv = document.getElementById(`details-${name}`);
            if (detailsDiv) {
                const isVisible = detailsDiv.style.display !== 'none';
                detailsDiv.style.display = isVisible ? 'none' : 'block';
            }
        }

        // Save inline edit
        async function saveInlineEdit(name) {
            const textarea = document.getElementById(`edit-${name}`);
            const newStyle = textarea.value.trim();

            if (!newStyle) {
                showAlert('הסטייל לא יכול להיות ריק', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/artists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, style: newStyle, password: sessionPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('האמן עודכן בהצלחה!', 'success');

                    // Reload and keep the artist in view with search filter
                    await loadArtists();

                    // Keep search focused on this artist
                    document.getElementById('searchInput').value = name;
                    currentSearchTerm = name.toLowerCase();

                    displayArtists(name);
                } else {
                    showAlert(data.error || 'שגיאה בשמירה', 'error');
                }
            } catch (error) {
                showAlert('שגיאת רשת', 'error');
            }
        }

        async function deleteArtist(name) {
            if (!confirm(`האם אתה בטוח שברצונך למחוק את ${name}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/artists/${encodeURIComponent(name)}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: sessionPassword })
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('האמן נמחק בהצלחה', 'success');
                    loadArtists();
                } else {
                    showAlert(data.error || 'שגיאה במחיקה', 'error');
                }
            } catch (error) {
                showAlert('שגיאת רשת', 'error');
            }
        }

        function editArtist(name, style) {
            document.getElementById('artistName').value = name;
            document.getElementById('artistStyle').value = style;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function regenerateArtist(name) {
            const llmProvider = document.getElementById('llmProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!apiKey) {
                showAlert('דרוש API key. הזן במקטע "הגדרות AI Generator".', 'error');
                return;
            }

            if (!confirm(`Regenerate style for "${name}" using AI?`)) {
                return;
            }

            // Find the artist card to show loading state
            const cards = document.querySelectorAll('.artist-card');
            let targetCard = null;
            for (const card of cards) {
                if (card.dataset.name === name) {
                    targetCard = card;
                    break;
                }
            }

            if (targetCard) {
                const styleDiv = targetCard.querySelector('.artist-style');
                const originalStyle = styleDiv.textContent;
                styleDiv.innerHTML = '<span style="color: #667eea;">⏳ Generating...</span>';
            }

            try {
                const response = await fetch(`${API_URL}/api/generate-style`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        artistName: name,
                        password: sessionPassword,
                        llmProvider,
                        apiKey: apiKey
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    const newStyle = data.generatedStyle;

                    // Auto-save the new style
                    const saveResponse = await fetch(`${API_URL}/api/artists`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            style: newStyle,
                            password: sessionPassword
                        })
                    });

                    if (saveResponse.ok) {
                        showAlert(`✨ "${name}" regenerated and saved!`, 'success');
                        loadArtists(); // Reload the list
                    } else {
                        throw new Error('Failed to save regenerated style');
                    }
                } else {
                    throw new Error(data.error || 'Failed to generate');
                }
            } catch (error) {
                showAlert('שגיאה: ' + error.message, 'error');
                if (targetCard) {
                    loadArtists(); // Reload to restore original
                }
            }
        }

        function setupToggleListener() {
            document.getElementById('enableToggle').addEventListener('change', async function() {
                try {
                    const response = await fetch(`${API_URL}/api/toggle`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: sessionPassword })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        artistsData.enabled = data.enabled;
                        updateStats();
                        showAlert(`המערכת ${data.enabled ? 'הופעלה' : 'כובתה'} בהצלחה`, 'success');
                    } else {
                        showAlert(data.error || 'שגיאה', 'error');
                        this.checked = !this.checked;
                    }
                } catch (error) {
                    showAlert('שגיאת רשת', 'error');
                    this.checked = !this.checked;
                }
            });
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'error' ? 'alert-error' : 'alert-success';

            alertContainer.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;

            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, "\\'");
        }

        // Download artists as JSON
        function downloadJSON() {
            if (!artistsData || !artistsData.artists) {
                showAlert('אין נתונים להורדה', 'error');
                return;
            }

            const jsonData = JSON.stringify(artistsData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];

            a.href = url;
            a.download = `artist_styles_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showAlert('הקובץ הורד בהצלחה!', 'success');
            console.log('Downloaded artist_styles.json');
        }

        // AI Style Generator
        async function generateStyle() {
            const artistNameInput = document.getElementById('artistName').value.trim();
            const llmProvider = document.getElementById('llmProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const generateBtn = document.getElementById('generateBtn');
            const originalText = generateBtn.innerHTML;

            if (!artistNameInput) {
                showAlert('נא להזין שם אמן תחילה', 'error');
                return;
            }

            // Check if API key is available
            if (!apiKey) {
                showAlert(`דרוש API key. הזן במקטע "הגדרות AI Generator".`, 'error');
                return;
            }

            // Auto-save API key if checkbox is checked
            const saveApiKeyCheckbox = document.getElementById('saveApiKey');
            if (saveApiKeyCheckbox.checked && apiKey) {
                saveApiKeyToLocalStorage(llmProvider, apiKey);
            }

            // Check if multiple artists (separated by commas)
            const artistNames = artistNameInput.split(',').map(name => name.trim()).filter(name => name.length > 0);

            if (artistNames.length === 0) {
                showAlert('נא להזין שם אמן תקין', 'error');
                return;
            }

            // Check regenerate existing checkbox
            const regenerateExisting = document.getElementById('regenerateExisting').checked;

            // Show loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = `⏳ טוען נתונים...`;

            let successCount = 0;
            let failCount = 0;
            let skippedCount = 0;
            let regeneratedCount = 0;
            let newCount = 0;

            try {
                // Load fresh artist data from server to check which artists already exist
                console.log('🔄 Loading fresh artist data from server...');
                const artistsResponse = await fetch(`${API_URL}/api/artists`);
                const currentArtistsData = await artistsResponse.json();
                console.log(`📊 Loaded ${Object.keys(currentArtistsData.artists || {}).length} existing artists`);
                console.log(`⚙️ Regenerate existing: ${regenerateExisting ? 'YES' : 'NO'}`);

                // Update loading state
                generateBtn.innerHTML = `⏳ מעבד ${artistNames.length} אמנים...`;

                for (const artistName of artistNames) {
                    try {
                        // Check if artist already exists (case-sensitive exact match)
                        const artistExists = currentArtistsData.artists && currentArtistsData.artists[artistName];

                        console.log(`🔍 Checking "${artistName}": ${artistExists ? 'EXISTS' : 'NEW'}`);

                        // Skip if exists and regenerateExisting is not checked
                        if (artistExists && !regenerateExisting) {
                            skippedCount++;
                            console.log(`⏭️ "${artistName}": SKIPPED (already exists, regenerate is OFF)`);
                            continue;
                        }

                        if (artistExists && regenerateExisting) {
                            console.log(`🔄 "${artistName}": REGENERATING (already exists, regenerate is ON)`);
                        } else {
                            console.log(`✨ "${artistName}": CREATING NEW`);
                        }

                        // Generate style for this artist
                        const response = await fetch(`${API_URL}/api/generate-style`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                artistName,
                                password: sessionPassword,
                                llmProvider,
                                apiKey: apiKey
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const generatedStyle = data.generatedStyle;

                            // Auto-save this artist
                            const saveResponse = await fetch(`${API_URL}/api/artists`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: artistName,
                                    style: generatedStyle,
                                    password: sessionPassword
                                })
                            });

                            if (saveResponse.ok) {
                                successCount++;
                                if (artistExists) {
                                    regeneratedCount++;
                                    console.log(`🔄 ${artistName}: regenerated`);
                                } else {
                                    newCount++;
                                    console.log(`✓ ${artistName}: created new`);
                                }
                            } else {
                                failCount++;
                                console.error(`✗ ${artistName}: generated but failed to save`);
                            }
                        } else {
                            failCount++;
                            console.error(`✗ ${artistName}: ${data.error}`);
                        }
                    } catch (error) {
                        failCount++;
                        console.error(`✗ ${artistName}: ${error.message}`);
                    }
                }

                // Clear the input fields
                document.getElementById('artistName').value = '';
                document.getElementById('artistStyle').value = '';

                // Reload artists list
                loadArtists();

                // Build detailed result message
                let resultParts = [];
                if (newCount > 0) resultParts.push(`✨ ${newCount} חדשים`);
                if (regeneratedCount > 0) resultParts.push(`🔄 ${regeneratedCount} regenerated`);
                if (skippedCount > 0) resultParts.push(`⏭️ ${skippedCount} נדלגו`);
                if (failCount > 0) resultParts.push(`❌ ${failCount} נכשלו`);

                const resultMessage = resultParts.join(' | ');

                // Show results
                if (successCount > 0 || skippedCount > 0) {
                    showAlert(`סיימתי! ${resultMessage}`, successCount > 0 ? 'success' : 'error');
                } else {
                    showAlert(`❌ כל ${failCount} האמנים נכשלו`, 'error');
                }

                // Success animation
                if (successCount > 0) {
                    generateBtn.innerHTML = `✅ הושלם: ${successCount} success | ${skippedCount} skipped`;
                    generateBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                } else if (skippedCount > 0) {
                    generateBtn.innerHTML = `⏭️ ${skippedCount} אמנים נדלגו`;
                    generateBtn.style.background = 'linear-gradient(135deg, #6c757d 0%, #5a6268 100%)';
                } else {
                    generateBtn.innerHTML = `❌ ${failCount} נכשלו`;
                    generateBtn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                }

                setTimeout(() => {
                    generateBtn.innerHTML = originalText;
                    generateBtn.style.background = '';
                    generateBtn.disabled = false;
                }, 4000);

            } catch (error) {
                showAlert('שגיאה כללית: ' + error.message, 'error');
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
            }
        }

        // Regenerate Selected Artists
        async function regenerateSelected() {
            if (selectedArtists.size === 0) {
                showAlert('לא נבחרו אמנים', 'error');
                return;
            }

            const llmProvider = document.getElementById('llmProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!apiKey) {
                showAlert('דרוש API key. הזן במקטע "הגדרות AI Generator".', 'error');
                return;
            }

            if (!confirm(`Regenerate ${selectedArtists.size} selected artists using AI?`)) {
                return;
            }

            const regenerateBtn = document.getElementById('regenerateSelectedBtn');
            const originalText = regenerateBtn.innerHTML;
            regenerateBtn.disabled = true;
            regenerateBtn.innerHTML = `⏳ מעבד ${selectedArtists.size} אמנים...`;

            let successCount = 0;
            let failCount = 0;

            try {
                const selectedNames = Array.from(selectedArtists);

                for (const artistName of selectedNames) {
                    try {
                        // Find the card and show loading
                        const card = document.querySelector(`.artist-card[data-name="${artistName}"]`);
                        if (card) {
                            const styleDiv = card.querySelector('.artist-style');
                            styleDiv.innerHTML = '<span style="color: #667eea;">⏳ Generating...</span>';
                        }

                        // Generate new style
                        const response = await fetch(`${API_URL}/api/generate-style`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                artistName,
                                password: sessionPassword,
                                llmProvider,
                                apiKey: apiKey
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const newStyle = data.generatedStyle;

                            // Auto-save
                            const saveResponse = await fetch(`${API_URL}/api/artists`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: artistName,
                                    style: newStyle,
                                    password: sessionPassword
                                })
                            });

                            if (saveResponse.ok) {
                                successCount++;
                                console.log(`✓ ${artistName}: regenerated`);
                            } else {
                                failCount++;
                            }
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                        console.error(`✗ ${artistName}: ${error.message}`);
                    }
                }

                // Clear selection
                selectedArtists.clear();

                // Reload
                await loadArtists();
                displayArtists();

                if (successCount > 0) {
                    showAlert(`✨ ${successCount} אמנים regenerated!${failCount > 0 ? ` (${failCount} נכשלו)` : ''}`, 'success');
                } else {
                    showAlert(`❌ כל ${failCount} האמנים נכשלו`, 'error');
                }

            } catch (error) {
                showAlert('שגיאה: ' + error.message, 'error');
            } finally {
                regenerateBtn.innerHTML = originalText;
                regenerateBtn.disabled = selectedArtists.size === 0;
            }
        }

        // Regenerate All Artists
        async function regenerateAll() {
            const llmProvider = document.getElementById('llmProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();

            if (!apiKey) {
                showAlert('דרוש API key. הזן במקטע "הגדרות AI Generator".', 'error');
                return;
            }

            const totalArtists = Object.keys(artistsData.artists).length;

            if (!confirm(`⚠️ WARNING: This will regenerate ALL ${totalArtists} artists using AI. This may take a while and cost API credits. Continue?`)) {
                return;
            }

            showAlert(`🔥 Starting regeneration of ${totalArtists} artists...`, 'success');

            let successCount = 0;
            let failCount = 0;

            try {
                const allArtists = Object.keys(artistsData.artists);

                for (let i = 0; i < allArtists.length; i++) {
                    const artistName = allArtists[i];

                    try {
                        console.log(`[${i + 1}/${allArtists.length}] Regenerating: ${artistName}`);

                        // Generate new style
                        const response = await fetch(`${API_URL}/api/generate-style`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                artistName,
                                password: sessionPassword,
                                llmProvider,
                                apiKey: apiKey
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const newStyle = data.generatedStyle;

                            // Auto-save
                            const saveResponse = await fetch(`${API_URL}/api/artists`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: artistName,
                                    style: newStyle,
                                    password: sessionPassword
                                })
                            });

                            if (saveResponse.ok) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                        } else {
                            failCount++;
                        }

                        // Update progress every 10 artists
                        if ((i + 1) % 10 === 0) {
                            showAlert(`Progress: ${i + 1}/${allArtists.length} (✓ ${successCount} | ✗ ${failCount})`, 'success');
                        }

                    } catch (error) {
                        failCount++;
                        console.error(`✗ ${artistName}: ${error.message}`);
                    }
                }

                // Reload
                await loadArtists();
                displayArtists();

                showAlert(`✅ Regeneration complete! ✓ ${successCount} | ✗ ${failCount}`, 'success');

            } catch (error) {
                showAlert('שגיאה: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
